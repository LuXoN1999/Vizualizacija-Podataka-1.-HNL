<!DOCTYPE html>
<html>

<head>
    <title>1. HNL</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="./mainVariables.js"></script>
    <script src="./league.js"></script>
    <script src="./teams.js"></script>
    <script src="./additionalFunctions.js"></script>

</head>

<body>

</body>
<script>
    var svg = d3.select("body")
        .append("svg")
        .attr("width", HNLsvgWidth)
        .attr("height", HNLsvgHeight)
        .style("border-radius", defaultBorderRadius)
        .style("background-color", "#808080")
        .style("opacity", 0.75);

    svg.append("image")
        .attr("x", leagueLogoX)
        .attr("y", leagueLogoY)
        .attr("width", leagueLogoWidth)
        .attr("height", leagueLogoHeight)
        .attr("xlink:href", "./Images/HNL.png");

    svg.append("text")
        .text("OMJER KLUBOVA")
        .attr("x", svgWidth / 2 - 265)
        .attr("y", commonTitleTextY)
        .style("font-size", normalTextFontSize)
        .style("font-family", defaultFontFamily);

    svg.append("text")
        .text("PODACI O LIGI")
        .attr("x", svgWidth / 2 + 10)
        .attr("y", commonTitleTextY)
        .style("font-size", normalTextFontSize)
        .style("font-family", defaultFontFamily);

    svg.append("line")
        .attr("x1", HNLsvgWidth / 2)
        .attr("y1", commonTitleTextY - 50)
        .attr("x2", HNLsvgWidth / 2)
        .attr("y2", HNLsvgHeight)
        .style("stroke-width", 5)
        .style("stroke", "black");

    //GOAL RATIO  SCATTER PLOT
    var goalRatioText = svg.append("text")
        .text("Omjer golova")
        .attr("x", commonGoalRatioTextElementX)
        .attr("y", commonFirstElementY - textElementDifference)
        .style("font-size", normalTextFontSize)
        .style("font-family", defaultFontFamily);

    var goalRatioScatterplotContainer = svg.append("g")
        .attr("transform", "translate(" + commonClubRatioElementX + "," + commonFirstElementY + ")");

    var scoredGoalsArray = teamsData.map(object => { return object.goals; })
    var concededGoalsArray = teamsData.map(object => { return object.goalsconceded; })

    var goalRatioScatterplotXScale = d3.scaleLinear()
        .range([0, defaultClubRatioElementWidth])
        .domain([Math.min(...concededGoalsArray) - 5, Math.max(...concededGoalsArray) + 5]);

    var goalRatioScatterplotYScale = d3.scaleLinear()
        .range([defaultClubRatioElementHeight, 0])
        .domain([Math.min(...scoredGoalsArray) - 5, Math.max(...scoredGoalsArray) + 5]);

    var xAxisGoalRatio = goalRatioScatterplotContainer.append("g")
        .attr("transform", "translate(0," + defaultClubRatioElementHeight + ")")
        .call(d3.axisBottom(goalRatioScatterplotXScale).ticks(15));

    var yAxisGoalRatio = goalRatioScatterplotContainer.append("g")
        .call(d3.axisLeft(goalRatioScatterplotYScale).ticks(15))

    goalRatioScatterplotContainer.append("text")
        .text("Primljeni golovi")
        .attr("x", defaultClubRatioElementWidth / 2)
        .attr("y", defaultClubRatioElementHeight + 45)
        .style("font-size", smallTextFontSize)
        .style("font-family", defaultFontFamily);

    goalRatioScatterplotContainer.append("text")
        .text("Zabijeni golovi")
        .attr("y", -45)
        .attr("x", -150)
        .attr("transform", "rotate(-90)")
        .style("font-size", smallTextFontSize)
        .style("font-family", defaultFontFamily);

    var tooltip = goalRatioScatterplotContainer
        .append("text")
        .attr("font-weight", 550)
        .style("opacity", 0)
        .style("font-size", ultrasmallTextFontSize)
        .style("font-family", defaultFontFamily);

    goalRatioScatterplotContainer.append("g")
        .selectAll("g")
        .data(teamsData)
        .enter()
        .append("circle")
        .attr("id", function (d, i) { return d.name; })
        .attr("cx", 0)
        .attr("cy", defaultClubRatioElementHeight)
        .attr("r", 7)
        .style("fill", function (d) {
            switch (d.name) {
                case "HNK Hajduk Split": return "white"; break;
                case "NK Osijek": return "#5cb7e8"; break;
                case "GNK Dinamo Zagreb": return "blue"; break;
                case "NK Rijeka": return "lightblue"; break;
                case "HNK Gorica": return "red"; break;
                case "NK Lokomotiva": return "blue"; break;
                case "NK Slaven Belupo": return "blue"; break;
                case "HNK Sibenik": return "#ff7300"; break;
                case "NK Istra 1961": return "green"; break;
                case "NK Hrvatski Dragovoljac": return "black"; break;
            }
        })
        .on("mouseover", function (d, i) {
            var currentObject = i;
            var currentElementX = d3.select(this).attr("cx");
            var currentElementY = d3.select(this).attr("cy");
            d3.select(this)
                .style("stroke", "black")
                .transition()
                .duration(100)
                .attr("r", 10)
            tooltip
                .attr("x", currentElementX - 15)
                .attr("y", currentElementY - 15)
                .text(currentObject.name + " (zabijeno: " + currentObject.goals + ",primljeno: " + currentObject.goalsconceded + ")")
                .style("opacity", 1);
            tooltip.raise();
        })
        .on("mouseout", function (d, i) {
            d3.select(this)
                .style("stroke", "#808080")
                .transition()
                .duration(100)
                .attr("r", 7);
            tooltip
                .attr("x", 0)
                .attr("y", 0)
                .style("opacity", 0);
        })
        .transition()
        .duration(1500)
        .attr("cx", function (d, i) { return goalRatioScatterplotXScale(d.goalsconceded); })
        .attr("cy", function (d, i) { return goalRatioScatterplotYScale(d.goals); })


    //CLEANSHEETS BARCHART

    var cleansheetsText = svg.append("text")
        .text("Utakmice bez primljenih golova")
        .attr("x", commonGoalRatioTextElementX)
        .attr("y", commonSecondElementY - textElementDifference)
        .style("font-size", normalTextFontSize)
        .style("font-family", defaultFontFamily);

    var cleansheetsBarchartContainer = svg.append("g")
        .attr("transform", "translate(" + commonClubRatioElementX + "," + commonSecondElementY + " )");

    var cleansheetsArray = teamsData.map(object => { return object.cleansheets; })

    var cleansheetsBarchartXScale = d3.scaleBand()
        .range([0, defaultClubRatioElementWidth])
        .domain(teamsData.map(function (d) { return d.name; }))
        .padding(0.2);

    var cleansheetsBarchartYScale = d3.scaleLinear()
        .range([defaultClubRatioElementHeight, 0])
        .domain([0, Math.max(...cleansheetsArray)]);

    cleansheetsBarchartContainer.append("g")
        .attr("transform", "translate(0," + defaultClubRatioElementWidth + ")")
        .call(d3.axisBottom(cleansheetsBarchartXScale))
        .selectAll("text")
        .attr("transform", "translate(-10,0)rotate(-45)")
        .style("text-anchor", "end")
        .style("font-size", ultrasmallTextFontSize)
        .style("font-family", defaultFontFamily);

    cleansheetsBarchartContainer.append("g")
        .call(d3.axisLeft(cleansheetsBarchartYScale));

    cleansheetsBarchartContainer.append("text")
        .attr("id", "cleansheetsRectText")
        .attr("x", 0)
        .attr("y", 0)
        .style("font-size", smallTextFontSize)
        .style("font-family", defaultFontFamily);

    cleansheetsBarchartContainer.selectAll("mybar")
        .data(teamsData)
        .enter()
        .append("rect")
        .attr("x", 0)
        .attr("y", function (d) { return cleansheetsBarchartYScale(d.cleansheets); })
        .attr("width", cleansheetsBarchartXScale.bandwidth())
        .attr("height", function (d) { return defaultClubRatioElementHeight - cleansheetsBarchartYScale(d.cleansheets); })
        .style("opacity", 0)
        .style("fill", "black")
        .on("mouseover", function (d, i) {
            var currentObject = i;
            d3.select(this)
                .transition()
                .duration(250)
                .style("fill", "red");
            d3.select("#cleansheetsRectText")
                .text(currentObject.cleansheets)
                .attr("x", function () {
                    if (currentObject.cleansheets > 9) {
                        return cleansheetsBarchartXScale(currentObject.name) + cleansheetsBarchartXScale.bandwidth() / 4 - 5;
                    }
                    return cleansheetsBarchartXScale(currentObject.name) + cleansheetsBarchartXScale.bandwidth() / 4;
                })
                .attr("y", cleansheetsBarchartYScale(currentObject.cleansheets) - 1)
                .style("opacity", 1);
        })
        .on("mouseout", function (d, i) {
            d3.select(this)
                .transition()
                .duration(250)
                .style("fill", "black");
            d3.select("#cleansheetsRectText")
                .style("opacity", 0);
        })
        .transition()
        .duration(1500)
        .attr("x", function (d) { return cleansheetsBarchartXScale(d.name); })
        .style("opacity", 1);

    //OVERALL MARKET VALUE LINECHART

    var overallGoalsText = svg.append("text")
        .text("Golovi: " + leagueDataBySeasons[4].goalsscored)
        .attr("x", commonGoalRatioTextElementX)
        .attr("y", commonThirdElementY)
        .style("font-size", normalTextFontSize)
        .style("font-family", defaultFontFamily);

    var overallGoalsContainer = svg.append("g")
        .attr("transform", "translate(" + (overallGoalsPiechartX + 75) + "," + (commonThirdElementY + 200) + " )");

    var overallGoalsPie = d3.pie()
        .value(function (d) { return d.goals; });

    var overallGoalsPercentageText = overallGoalsContainer.append("text")
        .text("")
        .attr("x", 10 - innerRadius2 / 2)
        .attr("y", -5)
        .style("font-size", normalTextFontSize)
        .style("font-family", defaultFontFamily)
        .style("fill", "red")
        .style("opacity", 0);

    var additionalText = overallGoalsContainer.append("text")
        .text("od svih golova")
        .attr("x", -65)
        .attr("y", 15)
        .style("font-size", smallTextFontSize)
        .style("font-family", defaultFontFamily)
        .style("fill", "red")
        .style("opacity", 0);

    var overallGoalsPieArcs = svg.selectAll("g.pie")
        .data(overallGoalsPie(teamsData))
        .enter()
        .append("path")
        .attr("transform", "translate(" + (overallGoalsPiechartX + 75) + ", " + (commonThirdElementY + 200) + ")")
        .attr("d", goalsDefaultArc)
        .attr("stroke", "#808080")
        .style("stroke-width", "3px")
        .style("fill", "black")
        .on("mouseover", function (d, i) {
            var currentObject = i;
            d3.select(this)
                .transition()
                .duration(250)
                .style("fill", "red");
            overallGoalsPercentageText
                .text((i.data.goals / leagueDataBySeasons[4].goalsscored * 100).toFixed(1) + "%")
                .transition()
                .duration(200)
                .style("opacity", 1);
            additionalText
                .transition()
                .duration(200)
                .style("opacity", 1);
        })
        .on("mouseout", function () {
            d3.select(this)
                .transition()
                .duration(250)
                .style("fill", "black");
            overallGoalsPercentageText
                .style("opacity", 0);
            additionalText
                .style("opacity", 0);
        })

    overallGoalsContainer.selectAll("allPolylines")
        .data(overallGoalsPie(teamsData))
        .enter()
        .append("polyline")
        .attr("stroke", "black")
        .style("fill", "none")
        .attr("stroke-width", 2)
        .attr("points", function (d) {
            var posA = goalsDefaultArc.centroid(d);
            var posB = goalsOuterArc.centroid(d);
            var posC = goalsOuterArc.centroid(d);
            var midangle = d.startAngle + (d.endAngle - d.startAngle) / 2;
            posC[0] = goalsRadius * 0.95 * (midangle < Math.PI ? 1 : -1);
            return [posA, posB, posC];
        });

    overallGoalsContainer.selectAll("allLabels")
        .data(overallGoalsPie(teamsData))
        .enter()
        .append("text")
        .text(function (d) { return d.data.name + "(" + d.data.goals + ")"; })
        .attr("transform", function (d) {
            var pos = goalsOuterArc.centroid(d);
            var midangle = d.startAngle + (d.endAngle - d.startAngle) / 2
            pos[0] = goalsRadius * 0.99 * (midangle < Math.PI ? 1 : -1);
            return "translate(" + pos + ")";
        })
        .style("text-anchor", function (d) {
            var midangle = d.startAngle + (d.endAngle - d.startAngle) / 2
            return (midangle < Math.PI ? "start" : "end")
        })
        .style("font-size", goalsPiechartLabelFontSize)
        .style("font-family", defaultFontFamily);

    //WINS LINECHART
    var winsLinechartText = svg.append("text")
        .text("Sveukupna vrijednost(€)")
        .attr("x", commonLeagueStatsTextElementX)
        .attr("y", commonFirstElementY - textElementDifference)
        .style("font-size", normalTextFontSize)
        .style("font-family", defaultFontFamily);


    var marketValueContainer = svg.append("g")
        .attr("transform", "translate(" + commonLeagueStatsElementX + "," + commonFirstElementY + ")");

    var marketValueBySeasonsArray = leagueDataBySeasons.map(object => { return object.marketvalue / 1000000; })
    var seasonsArray = leagueDataBySeasons.map(object => { return object.seasonyear; })

    var marketValueXScale = d3.scaleBand()
        .domain(seasonsArray)
        .range([0, defaultLeagueStatsElementWidth])
        .padding(1);

    var marketValueYScale = d3.scaleLinear()
        .domain([(Math.max(...marketValueBySeasonsArray) + 15), (Math.min(...marketValueBySeasonsArray) - 15)])
        .range([0, defaultLeagueStatsElementHeight]);

    marketValueContainer.append("g")
        .attr("transform", "translate(0," + defaultLeagueStatsElementHeight + ")")
        .call(d3.axisBottom(marketValueXScale));

    marketValueContainer.append("g")
        .call(d3.axisLeft(marketValueYScale));


    marketValueContainer.append("text")
        .text("Vrijednost[M€]")
        .attr("y", -45)
        .attr("x", -150)
        .attr("transform", "rotate(-90)")
        .style("font-size", smallTextFontSize)
        .style("font-family", defaultFontFamily);

    marketValueContainer.append("path")
        .datum(leagueDataBySeasons)
        .attr("fill", "none")
        .attr("stroke", "black")
        .attr("stroke-width", 2)
        .attr("d", d3.line()
            .x(function (d) { return marketValueXScale(d.seasonyear); })
            .y(function (d) { return marketValueYScale(d.marketvalue / 1000000); })
        )

    var marketValueText = marketValueContainer.append("text")
        .style("opacity", 0)
        .attr("font-weight", 550)
        .style("font-size", ultrasmallTextFontSize)
        .style("font-family", defaultFontFamily);

    marketValueContainer.append("g")
        .selectAll("dot")
        .data(leagueDataBySeasons)
        .enter()
        .append("circle")
        .attr("cx", function (d) { return marketValueXScale(d.seasonyear); })
        .attr("cy", function (d) { return marketValueYScale(d.marketvalue / 1000000); })
        .attr("r", 5)
        .attr("fill", "black")
        .on("mouseover", function (d, i) {
            var currentObject = i;
            d3.select(this)
                .style("fill", "red")
                .transition()
                .duration(100)
                .attr("r", 7);
            marketValueText
                .text(currentObject.marketvalue / 1000000 + "M €")
                .attr("x", function (d) { return marketValueXScale(currentObject.seasonyear); })
                .attr("y", function (d) { return marketValueYScale(currentObject.marketvalue / 1000000) - 15; })
                .style("opacity", 1);
        })
        .on("mouseout", function () {
            d3.select(this)
                .style("fill", "black")
                .transition()
                .duration(100)
                .attr("r", 5);
            marketValueText
                .style("opacity", 0);
        });

    //HOME/AWAY WIN BARCHART

    var winsLinechartText = svg.append("text")
        .text("Pobjeda Domaćina/Gosta + Neriješeno")
        .attr("x", commonLeagueStatsTextElementX)
        .attr("y", commonSecondElementY - textElementDifference)
        .style("font-size", normalTextFontSize)
        .style("font-family", defaultFontFamily);

    var matchesBySeasonsContainer = svg.append("g")
        .attr("transform", "translate(" + commonLeagueStatsElementX + "," + commonSecondElementY + ")")

    var choices = ["Domaći", "Gosti", "Neriješeno", "Sveukupno"];

    var customButtons = matchesBySeasonsContainer.selectAll("rect")
        .data(choices)
        .enter()
        .append("rect")
        .attr("id", function (d, i) { return "button" + i })
        .attr("x", function (d, i) {
            if (i == 0) {
                return 0 + i * buttonWidth;
            }
            return 0 + i * buttonWidth + buttonOffset * i;
        })
        .attr("y", defaultClubRatioElementHeight + 55)
        .attr("width", buttonWidth)
        .attr("height", buttonHeight)
        .attr("stroke", "black")
        .style("fill", function (d, i) {
            if (i == 0) { return "green"; }
            else if (i == 1) { return "blue"; }
            else if (i == 2) { return "magenta"; }
            return "red";
        })
        .on("click", function () {
            var currentElementID = d3.select(this).attr("id");
            customButtons
                .attr("stroke-width", 1)
                .attr("height", buttonHeight);
            d3.select(this)
                .attr("stroke-width", 3)
                .attr("height", buttonHeight - 10);
            switch (currentElementID) {
                case "button0": displayHomeWins(); break;
                case "button1": displayAwayWins(); break;
                case "button2": displayDraws(); break;
                case "button3": displayOverallMatches(); break;
            }
        })
        .on("mouseover", function () {
            customButtons
                .attr("stroke-width", 1);
            d3.select(this)
                .attr("stroke-width", 3);
        })
        .on("mouseout", function () {
            customButtons
                .attr("stroke-width", 1);
        })

    var customButtonsText = matchesBySeasonsContainer.selectAll("text")
        .data(choices)
        .enter()
        .append("text")
        .text(function (d) { return d; })
        .attr("x", function (d, i) {
            if (i == 0) {
                return 0 + i * buttonWidth;
            }
            return 0 + i * buttonWidth + buttonOffset * i;
        })
        .attr("y", defaultClubRatioElementHeight + 45);

    var matchesXScale = d3.scaleBand()
        .domain(seasonsArray)
        .range([0, (defaultLeagueStatsElementWidth + 150)])
        .padding(1);

    homeWinsBySeason = leagueDataBySeasons.map(object => { return object.hometeamwins; });
    awayWinsBySeason = leagueDataBySeasons.map(object => { return object.awayteamwins; });
    drawsBySeason = leagueDataBySeasons.map(object => { return object.draws; });

    var matchesYScale = d3.scaleLinear()
        .domain([overallMaxMatches() + 5, overallMinMatches() - 5])
        .range([0, defaultLeagueStatsElementHeight]);

    matchesBySeasonsContainer.append("g")
        .attr("transform", "translate(0," + defaultLeagueStatsElementHeight + ")")
        .call(d3.axisBottom(matchesXScale));

    matchesBySeasonsContainer.append("g")
        .call(d3.axisLeft(matchesYScale));


    var barText = matchesBySeasonsContainer.selectAll("barText")
        .data(leagueDataBySeasons)
        .enter()
        .append("text")
        .attr("x", function (d) { return matchesXScale(d.seasonyear) - 12.5; })
        .attr("y", 0)
        .style("font-size", smallTextFontSize)
        .style("font-family", defaultFontFamily)
        .style("opacity", 0);

</script>

</html>